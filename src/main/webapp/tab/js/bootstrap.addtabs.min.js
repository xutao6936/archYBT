/**
 * Website: http://git.oschina.net/hbbcs/bootStrap-addTabs
 *
 * Version : 1.5
 *
 * Created by joe on 2016-2-4.
 */
$.fn.addtabs = function(a) {
    obj = $(this);
    Addtabs.options = $.extend({
        content: "",
        close: true,
        monitor: "body",
        iframeUse: true,
        iframeHeight: $(document).height() - 107,
        method: "init",
        contextmenu: true,
        callback: function() {}
    },
    a || {});
    $(Addtabs.options.monitor).on("click", "[data-addtab]",
    function() {
        Addtabs.add({
            id: $(this).attr("data-addtab"),
            title: $(this).attr("title") ? $(this).attr("title") : $(this).html(),
            content: Addtabs.options.content ? Addtabs.options.content: $(this).attr("content"),
            url: $(this).attr("url"),
            ajax: $(this).attr("ajax") ? true: false
        })
    });
    obj.on("click", ".close-tab",
    function() {
        var b = $(this).prev("a").attr("aria-controls");
        Addtabs.close(b)
    });
    if (Addtabs.options.contextmenu) {
        obj.on("contextmenu", "li[role=presentation]",
        function() {
            var b = $(this).children("a").attr("aria-controls");
            Addtabs.pop(b, $(this));
            return false
        });
        obj.on("click", "ul.rightMenu a[data-right=refresh]",
        function() {
            var c = $(this).parent("ul").attr("aria-controls").substring(4);
            var b = $(this).parent("ul").attr("aria-url");
            Addtabs.add({
                id: c,
                url: b
            });
            $("#popMenu").fadeOut()
        });
        obj.on("click", "ul.rightMenu a[data-right=remove]",
        function() {
            var b = $(this).parent("ul").attr("aria-controls");
            if (b.substring(0, 4) != "tab_") {
                return
            }
            Addtabs.close(b);
            Addtabs.drop();
            $("#popMenu").fadeOut()
        });
        obj.on("click", "ul.rightMenu a[data-right=remove-circle]",
        function() {
            var b = $(this).parent("ul").attr("aria-controls");
            obj.children("ul.nav").find("li").each(function() {
                var c = $(this).attr("id");
                if (c && c != "tab_" + b) {
                    Addtabs.close($(this).children("a").attr("aria-controls"))
                }
            });
            Addtabs.drop();
            $("#popMenu").fadeOut()
        });
        obj.on("click", "ul.rightMenu a[data-right=remove-left]",
        function() {
            var b = $(this).parent("ul").attr("aria-controls");
            $("#tab_" + b).prevUntil().each(function() {
                var c = $(this).attr("id");
                if (c && c != "tab_" + b) {
                    Addtabs.close($(this).children("a").attr("aria-controls"))
                }
            });
            Addtabs.drop();
            $("#popMenu").fadeOut()
        });
        obj.on("click", "ul.rightMenu a[data-right=remove-right]",
        function() {
            var b = $(this).parent("ul").attr("aria-controls");
            $("#tab_" + b).nextUntil().each(function() {
                var c = $(this).attr("id");
                if (c && c != "tab_" + b) {
                    Addtabs.close($(this).children("a").attr("aria-controls"))
                }
            });
            Addtabs.drop();
            $("#popMenu").fadeOut()
        })
    }
    obj.on("mouseover", 'li[role = "presentation"]',
    function() {
        $(this).find(".close-tab").show()
    });
    obj.on("mouseleave", 'li[role = "presentation"]',
    function() {
        $(this).find(".close-tab").hide()
    });
    $(window).resize(function() {
        obj.find("iframe").attr("height", Addtabs.options.iframeHeight);
        Addtabs.drop()
    })
};
window.Addtabs = {
    options: {},
    add: function(b) {
        var d = "tab_" + b.id;
        $('li[role = "presentation"].active').removeClass("active");
        $('div[role = "tabpanel"].active').removeClass("active");
        if (!$("#" + d).length) {
            var c = $("<li>", {
                role: "presentation",
                id: "tab_" + d,
                "aria-url": b.url,
                draggable: true
            }).append($("<a>", {
                href: "#" + d,
                "aria-controls": d,
                role: "tab",
                "data-toggle": "tab"
            }).html(b.title));
            if (Addtabs.options.close) {
                c.append($("<i>", {
                    "class": "close-tab glyphicon glyphicon-remove"
                }))
            }
            var a = $("<div>", {
                "class": "tab-pane",
                id: d,
                role: "tabpanel"
            });
            obj.children(".nav-tabs").append(c);
            obj.children(".tab-content").append(a)
        } else {
            var a = $("#" + d);
            a.html("")
        }
        if (b.content) {
            a.append(b.content)
        } else {
            if (Addtabs.options.iframeUse && !b.ajax) {
                a.append($("<iframe>", {
                    "class": "iframeClass",
                    height: Addtabs.options.iframeHeight,
                    frameborder: "no",
                    border: "0",
                    src: b.url
                }))
            } else {
                $.get(b.url,
                function(e) {
                    a.append(e)
                })
            }
        }
        $("#tab_" + d).addClass("active");
        $("#" + d).addClass("active");
        Addtabs.drop()
    },
    pop: function(c, b) {
        $("body").find("#popMenu").remove();
        var a = $("<ul>", {
            "aria-controls": c,
            "class": "rightMenu list-group",
            id: "popMenu",
            "aria-url": b.attr("aria-url")
        }).append('<a href="javascript:void(0);" class="list-group-item" data-right="refresh"><i class="glyphicon glyphicon-refresh"></i> 刷新此标签</a><a href="javascript:void(0);" class="list-group-item" data-right="remove"><i class="glyphicon glyphicon-remove"></i> 关闭此标签</a><a href="javascript:void(0);" class="list-group-item" data-right="remove-circle"><i class="glyphicon glyphicon-remove-circle"></i> 关闭其他标签</a><a href="javascript:void(0);" class="list-group-item" data-right="remove-left"><i class="glyphicon glyphicon-chevron-left"></i> 关闭左侧标签</a><a href="javascript:void(0);" class="list-group-item" data-right="remove-right"><i class="glyphicon glyphicon-chevron-right"></i> 关闭右侧标签</a>');
        a.css({
            top: b[0].offsetHeight - 10 + "px",
            left: b[0].offsetLeft + 50 + "px"
        });
        a.appendTo(obj).fadeIn("slow");
        a.mouseleave(function() {
            $(this).fadeOut("slow")
        })
    },
    close: function(a) {
        if (obj.find("li.active").attr("id") === "tab_" + a) {
            $("#tab_" + a).prev().addClass("active");
            $("#" + a).prev().addClass("active")
        }
        $("#tab_" + a).remove();
        $("#" + a).remove();
        Addtabs.drop();
        Addtabs.options.callback()
    },
    closeAll: function() {
        $.each(obj.find("li[id]"),
        function() {
            var b = $(this).children("a").attr("aria-controls");
            $("#tab_" + b).remove();
            $("#" + b).remove()
        });
        obj.find('li[role = "presentation"]').first().addClass("active");
        var a = obj.find('li[role = "presentation"]').first().children("a").attr("aria-controls");
        $("#" + a).addClass("active");
        Addtabs.drop()
    },
    drop: function() {
        element = obj.find(".nav-tabs");
        var b = $("<li>", {
            "class": "dropdown pull-right hide tabdrop tab-drop"
        }).append($("<a>", {
            "class": "dropdown-toggle",
            "data-toggle": "dropdown",
            href: "#"
        }).append($("<i>", {
            "class": "glyphicon glyphicon-align-justify"
        })).append($("<b>", {
            "class": "caret"
        }))).append($("<ul>", {
            "class": "dropdown-menu"
        }));
        if (!$(".tabdrop").html()) {
            b.prependTo(element)
        } else {
            b = element.find(".tabdrop")
        }
        if (element.parent().is(".tabs-below")) {
            b.addClass("dropup")
        }
        var a = 0;
        element.append(b.find("li")).find(">li").not(".tabdrop").each(function() {
            if (this.offsetTop > 0 || element.width() - $(this).position().left - $(this).width() < 83) {
                b.find("ul").prepend($(this));
                a++
            }
        });
        if (a > 0) {
            b.removeClass("hide");
            if (b.find(".active").length == 1) {
                b.addClass("active")
            } else {
                b.removeClass("active")
            }
        } else {
            b.addClass("hide")
        }
    }
};